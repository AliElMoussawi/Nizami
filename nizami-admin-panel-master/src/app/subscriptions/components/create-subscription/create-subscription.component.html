<app-template>
  <div class="flex flex-col gap-9 pt-8 pb-24 pr-2 w-full h-full overflow-auto">
    <div class="flex flex-row justify-between items-center">
      <div class="text-3xl font-bold">
        Create New Subscription
      </div>
    </div>

    <div class="max-w-4xl">
      <form [formGroup]="subscriptionForm" (ngSubmit)="onSubmit()" class="space-y-6">
        <div class="bg-white p-6 rounded-xl border-2 border-grey9">
          <div class="space-y-6">
            
            <!-- User Email Input -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                User Email <span class="text-red-500">*</span>
              </label>
              <app-input
                formControlName="user_email"
                type="email"
                placeholder="Enter user email address"
                [class.border-red-500]="subscriptionForm.get('user_email')?.invalid && subscriptionForm.get('user_email')?.touched"
              ></app-input>
              @if (getFieldError('user_email')) {
                <p class="mt-1 text-sm text-red-600">{{ getFieldError('user_email') }}</p>
              }
            </div>

            <!-- Plan Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Plan <span class="text-red-500">*</span>
              </label>
              <select
                formControlName="plan"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                [class.border-red-500]="subscriptionForm.get('plan')?.invalid && subscriptionForm.get('plan')?.touched"
              >
                <option value="">Select a plan</option>
                @for (plan of plans; track plan.uuid) {
                  <option [value]="plan.uuid">
                    {{ formatPlanDisplayName(plan) }}
                  </option>
                }
              </select>
              
              @if (plans.length === 0) {
                <div class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <p class="text-sm text-yellow-800">
                    <strong>No plans available.</strong> Please add some plans to the database first.
                  </p>
                </div>
              }
              
              @if (getFieldError('plan')) {
                <p class="mt-1 text-sm text-red-600">{{ getFieldError('plan') }}</p>
              }
              
              @if (selectedPlan) {
                <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p class="text-sm text-blue-800">
                    <strong>Selected Plan:</strong> {{ selectedPlan.name }} ({{ selectedPlan.tier }})<br>
                    <strong>Price:</strong> ${{ getPlanPriceInDollars(selectedPlan) }}/{{ getIntervalUnitLabel(selectedPlan) }}<br>
                    <strong>Properties:</strong> {{ formatPlanProperties(selectedPlan) }}
                  </p>
                </div>
              }
            </div>


            <!-- Expiry Date - Always show -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Expiry Date <span class="text-red-500">*</span>
              </label>
              <app-input
                formControlName="expiry_date"
                type="datetime-local"
                [class.border-red-500]="subscriptionForm.get('expiry_date')?.invalid && subscriptionForm.get('expiry_date')?.touched"
              ></app-input>
              @if (getFieldError('expiry_date')) {
                <p class="mt-1 text-sm text-red-600">{{ getFieldError('expiry_date') }}</p>
              }
            </div>

          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4">
          <app-flat-button
            type="button"
            (onClick)="onCancel()"
            [disabled]="isLoading"
          >
            Cancel
          </app-flat-button>
          
          <app-button
            type="submit"
            [disabled]="subscriptionForm.invalid || isLoading"
          >
            Create Subscription
          </app-button>
        </div>
      </form>
    </div>
  </div>
</app-template>
